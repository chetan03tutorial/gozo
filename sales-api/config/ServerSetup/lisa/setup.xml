<project name="setup-was" default="setup">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties" />

    <property name="propFile" value="default.properties" />
    <property file="${propFile}" />


    <property name="concatenatePortDetails" value="false" />
    <property name="script.dir" value="jacl" />

    <target name="setup" depends="init, exec" />

    <target name="init" depends="help">
        <copy file="${propFile}" tofile="input.props" filtering="true" overwrite="true">
            <filterset>
                <filter token="jdbc.jar.location" value="${basedir}/.."/>
            </filterset>
        </copy>
        <if>
            <os family="unix" />
            <then>
                <property name="wsadmin" value="${profile.dir}/bin/wsadmin.sh" />
                <property name="startserver" value="${profile.dir}/bin/startServer.sh" />
                <property name="stopserver" value="${profile.dir}/bin/stopServer.sh" />
            </then>
            <else>
                <property name="wsadmin" value="${profile.dir}/bin/wsadmin.bat" />
                <property name="startserver" value="${profile.dir}/bin/startServer.bat" />
                <property name="stopserver" value="${profile.dir}/bin/stopServer.bat" />
            </else>
        </if>

        <property name="jvm.jacl" value="${script.dir}/jvm.jacl" />
        <property name="jdbc.jacl" value="${script.dir}/jdbc.jacl" />
        <property name="jdbc2.jacl" value="${script.dir}/jdbc2.jacl" />
        <property name="jdbc3.jacl" value="${script.dir}/jdbc3.jacl" />
        <property name="urls.jacl" value="${script.dir}/urls.jacl" />
        <property name="workmgr.jacl" value="${script.dir}/workmgr.jacl" />

        <if>
            <equals arg1="${concatenatePortDetails}" arg2="true" />
            <then>
                <concat destfile="${propFile}" append="true">
                    <filelist dir="${profile.dir}/properties" files="portdef.props" />
                </concat>
            </then>
        </if>
    </target>

    <target name="help">
        <echo message="-------------------------------------------------------------------------------------------------------------------------------"/>
        <echo message="| Common usage ant -f setup.xml which picks properties from default.properties                                                 |"/>
        <echo message="| Using property file at ${propFile} to set properties. All the default properties are part of                                 |"/>
        <echo message="| default.properties which can be used to set properties for developers using windows environment.                             |"/>
        <echo message="| Otherwise you either create our own property file locally and specify it using -DpropFile=your_local_property_file.properties|"/>
        <echo message="| or can override common properties like                                                                                       |"/>
        <echo message="| -Dprofile.dir=location_of_websphere_profile_dir                                                                              |"/>
        <echo message="| -Dwas.node.name=websphere_node_name                                                                                          |"/>
        <echo message="| -Doracle.zip.location=os_specific_path_of_driver_relative_to_current_dir                                                     |"/>
        <echo message="| -Doracle.jar.file=for_websphere6.1_use_ojdbc5.jar_for_websphere8.5_use_ojdbc7.jar                                            |"/>
        <echo message="--------------------------------------------------------------------------------------------------------------------------------"/>
    </target>

    <target name="exec">
        <echo message="" />
        <echo message=" *** Starting Server ${srv.name}..." />
        <exec executable="${startserver}">
            <arg value="${srv.name}" />
        </exec>

        <echo message=" *** Executing ${workmgr.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${workmgr.jacl}" />
        </exec>

        <echo message="" />
        <echo message=" *** Executing ${jvm.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${jvm.jacl}" />
        </exec>

        <echo message="" />
        <echo message=" *** Executing ${urls.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${urls.jacl}" />
        </exec>

        <echo message="" />
        <echo message=" *** Executing ${jdbc.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${jdbc.jacl}" />
        </exec>

        <echo message=" *** Executing ${jdbc2.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${jdbc2.jacl}" />
        </exec>

        <echo message=" *** Executing ${jdbc3.jacl} script..." />
        <exec executable="${wsadmin}">
            <arg line="-f" />
            <arg value="${jdbc3.jacl}" />
        </exec>

        <echo message="" />
        <echo message=" *** Stopping Server ${srv.name}..." />
        <exec executable="${stopserver}">
            <arg value="${srv.name}" />
        </exec>

        <!-- clean up -->
        <delete file="input.props" failonerror="false"/>

        <echo message="Wsadmin task completed ..." />
    </target>
</project>

